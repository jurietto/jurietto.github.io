name: Update Commits File

on:
  push:
    branches:
      - main  # Or your default branch
  schedule:
    - cron: '0 0 * * 0'  # Runs every Sunday at midnight (you can adjust this)

jobs:
  update_commits:
    runs-on: ubuntu-latest
    steps:
      # Checkout the repository
      - name: Checkout repository
        uses: actions/checkout@v2

      # Fetch commits from this year and write them to commits.json
      - name: Fetch commits from this year
        run: |
          # Get current year
          current_year=$(date +%Y)
          
          # Generate JSON array of commits
          git log --since="${current_year}-01-01" --until="${current_year}-12-31" --pretty=format:'{"author": "%an", "message": "%s", "date": "%ad"}' --date=iso | \
          jq -s '.' > temp_commits.json

          # If commits.json exists, merge with new commits; else initialize with new commits
          if [ -f commits.json ]; then
            # Merge existing commits with new commits
            jq -s '.[0] + .[1]' commits.json temp_commits.json > temp_merged.json
            mv temp_merged.json commits.json
          else
            # Create commits.json with current year's commits
            mv temp_commits.json commits.json
          fi

      # Commit and push the updated commits.json
      - name: Commit and push changes
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add commits.json
          git commit -m "Update commits.json with commits from this year" || echo "No changes to commit"
          git push origin main  # Make sure this points to your default branch
