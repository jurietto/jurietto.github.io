<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>/general/</title>
</head>

<body>

<h1>/general/</h1>

<form onsubmit="return false;">
  <table>
    <tr>
      <td>Name</td>
      <td><input id="username" placeholder="Anonymous"></td>
    </tr>
    <tr>
      <td>Comment</td>
      <td><textarea id="text" rows="10" cols="40"></textarea></td>
    </tr>
    <tr>
      <td></td>
      <td><button id="post">Post</button></td>
    </tr>
  </table>
</form>

<div id="comments"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {
  getFirestore,
  collection,
  addDoc,
  query,
  orderBy,
  onSnapshot
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyA8cIAiNrasL-cgjQMcN0V-7s3kYdtiRjs",
  authDomain: "chansi-ddd7e.firebaseapp.com",
  projectId: "chansi-ddd7e",
  appId: "1:650473918964:web:63be3d4f9794f315fe29a1"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const commentsRef = collection(db, "threads", "general", "comments");

document.getElementById("post").onclick = async () => {
  const text = document.getElementById("text").value.trim();
  const user =
    document.getElementById("username").value.trim() || "Anonymous";

  if (!text) return;

  await addDoc(commentsRef, {
    text,
    user,
    createdAt: Date.now()
  });

  document.getElementById("text").value = "";
};

const q = query(commentsRef, orderBy("createdAt"));

onSnapshot(q, snap => {
  const container = document.getElementById("comments");
  container.innerHTML = "";

  snap.forEach(doc => {
    const d = doc.data();
    const date = new Date(d.createdAt);

    const header = document.createElement("div");
    header.textContent =
      (d.user || "Anonymous") + " â€” " + date.toLocaleString();

    container.appendChild(header);

    d.text.split("\n").forEach(line => {
      const div = document.createElement("div");
      div.textContent = line;
      container.appendChild(div);
    });

    container.appendChild(document.createElement("br"));
  });
});
</script>

</body>
</html>
